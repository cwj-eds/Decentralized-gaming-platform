# 去中心化游戏平台开发文档

## 1. 项目概述

### 1.1 项目简介
去中心化游戏平台是一个基于区块链技术的综合性游戏生态系统，集成了游戏制作、智能体平台、资产管理、交易市场等核心功能。

### 1.2 核心特性
- 🎮 **游戏制作智能体**：用户通过自然语言描述即可生成游戏
- 🤖 **智能体生态**：用户可上传和交易各类智能体
- 💎 **数字资产管理**：统一管理游戏、智能体、代币等资产
- 🛒 **去中心化交易**：基于区块链的资产交易市场
- 🔐 **钱包集成**：通过Web3钱包实现用户身份验证
- 💰 **代币经济**：完整的代币充值、消费、奖励体系

### 1.3 技术栈
| 技术层 | 技术选型 | 版本 |
|--------|----------|------|
| 前端 | Thymeleaf | 3.x |
| 后端 | Spring Boot | 3.3.4 |
| 数据层 | MyBatis-Plus | 3.5.9 |
| AI集成 | Spring AI | 1.0.0-M6 |
| 数据库 | MySQL | 8.0+ |
| 缓存 | Redis | 7.0+ |
| 存储 | IPFS | - |
| API文档 | Swagger | 2.2.0 |
| 区块链 | Web3j | 4.10.3 |
| 主链 | 以太坊 | - |
| 智能合约 | Solidity | 0.8.x |
| 开发工具 | Hardhat | - |
| 测试网络 | Goerli/BSC Testnet | - |

## 2. 系统架构

### 2.1 总体架构图
```
┌─────────────────────────────────────────────────────────────┐
│                        前端层 (Thymeleaf)                    │
├─────────────────────────────────────────────────────────────┤
│                        控制器层 (Spring MVC)                 │
├─────────────────────────────────────────────────────────────┤
│                        业务逻辑层 (Service)                  │
├─────────────────────────────────────────────────────────────┤
│                        数据访问层 (MyBatis-Plus)             │
├─────────────────────────────────────────────────────────────┤
│  MySQL        │  Redis        │  IPFS         │  区块链      │
│  (关系数据)    │  (缓存)       │  (文件存储)    │  (智能合约)   │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 模块架构
```
DecentralizedGamingPlatform/
├── 用户管理模块 (User Management)
├── 游戏管理模块 (Game Management)
├── 智能体管理模块 (Agent Management)
├── 资产管理模块 (Asset Management)
├── 交易平台模块 (Trading Platform)
├── 支付充值模块 (Payment Module)
├── 区块链集成模块 (Blockchain Integration)
└── AI集成模块 (AI Integration)
```

## 3. 功能需求分析

### 3.1 首页功能
- **游戏展示区域**：展示平台所有已发布的游戏
- **导航栏**：包含五个核心入口
  - 智能体平台入口
  - 交易平台入口
  - 资产管理入口
  - 登录注册入口
  - 充值入口

### 3.2 智能体平台
#### 3.2.1 游戏制作智能体
- **输入**：用户自然语言描述
- **处理**：基于Spring AI和大语言模型生成游戏代码
- **输出**：符合平台区块链协议的游戏
- **流程**：
  1. 用户输入游戏描述
  2. AI解析需求并生成游戏逻辑
  3. 自动生成符合区块链标准的游戏代码
  4. 部署到用户资产管理中
  5. 用户可选择发布到平台

#### 3.2.2 智能体生态
- **智能体上传**：用户可上传自定义智能体
- **智能体管理**：查看、编辑、删除智能体
- **智能体交易**：在交易平台买卖智能体

### 3.3 资产管理
- **我的游戏**：显示用户制作的游戏
- **我的智能体**：显示用户上传的智能体
- **我的代币**：显示代币余额和交易记录
- **游戏道具**：显示拥有的游戏内资产
- **操作功能**：
  - 开始游戏
  - 发布游戏到平台
  - 上架资产到交易平台

### 3.4 交易平台
- **资产展示**：显示所有可交易资产
- **分类筛选**：按游戏、智能体、道具分类
- **交易功能**：
  - 上架资产
  - 购买资产
  - 交易历史查询
  - 价格趋势分析

### 3.5 用户系统
- **钱包连接**：通过MetaMask等钱包登录
- **用户档案**：钱包地址绑定用户信息
- **权限管理**：基于区块链的身份验证

### 3.6 充值系统
- **法币充值**：支持信用卡、银行转账等
- **代币兑换**：法币兑换平台代币
- **充值记录**：显示充值历史和状态

## 4. 数据库设计

### 4.1 用户相关表
```sql
-- 用户表
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    wallet_address VARCHAR(42) UNIQUE NOT NULL COMMENT '钱包地址',
    username VARCHAR(50) COMMENT '用户名',
    email VARCHAR(100) COMMENT '邮箱',
    avatar_url VARCHAR(255) COMMENT '头像URL',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 用户代币余额表
CREATE TABLE user_balances (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    token_type VARCHAR(20) NOT NULL COMMENT '代币类型',
    balance DECIMAL(20,8) NOT NULL DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 4.2 游戏相关表
```sql
-- 游戏表
CREATE TABLE games (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(100) NOT NULL COMMENT '游戏标题',
    description TEXT COMMENT '游戏描述',
    creator_id BIGINT NOT NULL COMMENT '创建者ID',
    game_code LONGTEXT COMMENT '游戏代码',
    game_assets_url VARCHAR(255) COMMENT '游戏资产URL(IPFS)',
    contract_address VARCHAR(42) COMMENT '合约地址',
    status ENUM('DRAFT', 'PENDING', 'PUBLISHED', 'REJECTED') DEFAULT 'DRAFT',
    play_count INT DEFAULT 0 COMMENT '游戏次数',
    rating DECIMAL(3,2) DEFAULT 0.0 COMMENT '评分',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (creator_id) REFERENCES users(id)
);

-- 游戏道具表
CREATE TABLE game_items (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    game_id BIGINT NOT NULL,
    item_name VARCHAR(100) NOT NULL,
    item_type VARCHAR(50) NOT NULL,
    rarity ENUM('COMMON', 'RARE', 'EPIC', 'LEGENDARY') DEFAULT 'COMMON',
    attributes JSON COMMENT '道具属性',
    contract_address VARCHAR(42) COMMENT 'NFT合约地址',
    token_id VARCHAR(100) COMMENT 'NFT Token ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (game_id) REFERENCES games(id)
);
```

### 4.3 智能体相关表
```sql
-- 智能体表
CREATE TABLE agents (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL COMMENT '智能体名称',
    description TEXT COMMENT '智能体描述',
    creator_id BIGINT NOT NULL COMMENT '创建者ID',
    agent_type VARCHAR(50) NOT NULL COMMENT '智能体类型',
    code_url VARCHAR(255) COMMENT '代码存储URL(IPFS)',
    model_url VARCHAR(255) COMMENT '模型文件URL(IPFS)',
    contract_address VARCHAR(42) COMMENT '合约地址',
    price DECIMAL(20,8) DEFAULT 0 COMMENT '价格',
    usage_count INT DEFAULT 0 COMMENT '使用次数',
    rating DECIMAL(3,2) DEFAULT 0.0 COMMENT '评分',
    status ENUM('ACTIVE', 'INACTIVE', 'BANNED') DEFAULT 'ACTIVE',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (creator_id) REFERENCES users(id)
);
```

### 4.4 交易相关表
```sql
-- 市场商品表
CREATE TABLE marketplace_items (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    seller_id BIGINT NOT NULL COMMENT '卖家ID',
    item_type ENUM('GAME', 'AGENT', 'GAME_ITEM') NOT NULL,
    item_id BIGINT NOT NULL COMMENT '商品ID',
    price DECIMAL(20,8) NOT NULL COMMENT '价格',
    currency VARCHAR(20) DEFAULT 'PLATFORM_TOKEN' COMMENT '货币类型',
    status ENUM('ACTIVE', 'SOLD', 'CANCELLED') DEFAULT 'ACTIVE',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (seller_id) REFERENCES users(id)
);

-- 交易记录表
CREATE TABLE transactions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    buyer_id BIGINT NOT NULL,
    seller_id BIGINT NOT NULL,
    marketplace_item_id BIGINT NOT NULL,
    amount DECIMAL(20,8) NOT NULL,
    currency VARCHAR(20) NOT NULL,
    tx_hash VARCHAR(66) COMMENT '区块链交易哈希',
    status ENUM('PENDING', 'COMPLETED', 'FAILED') DEFAULT 'PENDING',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (buyer_id) REFERENCES users(id),
    FOREIGN KEY (seller_id) REFERENCES users(id),
    FOREIGN KEY (marketplace_item_id) REFERENCES marketplace_items(id)
);
```

### 4.5 支付充值表
```sql
-- 充值记录表
CREATE TABLE recharge_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    amount DECIMAL(20,8) NOT NULL COMMENT '充值金额',
    currency VARCHAR(20) NOT NULL COMMENT '货币类型',
    payment_method VARCHAR(50) NOT NULL COMMENT '支付方式',
    payment_id VARCHAR(100) COMMENT '第三方支付ID',
    tx_hash VARCHAR(66) COMMENT '区块链交易哈希',
    status ENUM('PENDING', 'COMPLETED', 'FAILED', 'CANCELLED') DEFAULT 'PENDING',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 4.6 游戏会话表
```sql
-- 游戏会话表
CREATE TABLE game_sessions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '玩家ID',
    game_id BIGINT NOT NULL COMMENT '游戏ID',
    session_token VARCHAR(100) UNIQUE NOT NULL COMMENT '会话令牌',
    start_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '开始时间',
    end_time TIMESTAMP NULL COMMENT '结束时间',
    score INT DEFAULT 0 COMMENT '游戏得分',
    rewards_earned DECIMAL(20,8) DEFAULT 0 COMMENT '获得奖励',
    status ENUM('ACTIVE', 'COMPLETED', 'ABANDONED') DEFAULT 'ACTIVE',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (game_id) REFERENCES games(id)
);
```

### 4.7 用户资产表
```sql
-- 用户资产表 (统一管理各类资产所有权)
CREATE TABLE user_assets (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    asset_type ENUM('GAME', 'AGENT', 'GAME_ITEM') NOT NULL COMMENT '资产类型',
    asset_id BIGINT NOT NULL COMMENT '资产ID',
    contract_address VARCHAR(42) COMMENT 'NFT合约地址',
    token_id VARCHAR(100) COMMENT 'NFT Token ID',
    acquired_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '获得时间',
    acquisition_type ENUM('CREATED', 'PURCHASED', 'REWARDED', 'TRANSFERRED') NOT NULL COMMENT '获得方式',
    is_tradeable BOOLEAN DEFAULT TRUE COMMENT '是否可交易',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_user_asset (user_id, asset_type),
    INDEX idx_contract_token (contract_address, token_id)
);
```

### 4.8 系统配置表
```sql
-- 系统配置表
CREATE TABLE system_configs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    config_key VARCHAR(100) UNIQUE NOT NULL COMMENT '配置键',
    config_value TEXT NOT NULL COMMENT '配置值',
    config_type VARCHAR(20) DEFAULT 'STRING' COMMENT '配置类型',
    description TEXT COMMENT '配置描述',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 插入默认配置
INSERT INTO system_configs (config_key, config_value, config_type, description) VALUES
('platform.token.symbol', 'PLT', 'STRING', '平台代币符号'),
('platform.token.contract', '', 'STRING', '平台代币合约地址'),
('game.creation.cost', '100.0', 'DECIMAL', '游戏创建成本'),
('agent.upload.cost', '50.0', 'DECIMAL', '智能体上传成本'),
('marketplace.fee.rate', '0.025', 'DECIMAL', '交易平台手续费率'),
('reward.game.play', '1.0', 'DECIMAL', '游戏游玩奖励'),
('reward.game.create', '10.0', 'DECIMAL', '游戏创建奖励');
```

## 5. API接口设计

### 5.1 用户管理API
```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    // 钱包登录
    @PostMapping("/wallet-login")
    public ResponseEntity<UserVO> walletLogin(@RequestBody WalletLoginRequest request);
    
    // 获取用户信息
    @GetMapping("/{userId}")
    public ResponseEntity<UserVO> getUserInfo(@PathVariable Long userId);
    
    // 更新用户信息
    @PutMapping("/{userId}")
    public ResponseEntity<UserVO> updateUser(@PathVariable Long userId, @RequestBody UpdateUserRequest request);
    
    // 获取用户余额
    @GetMapping("/{userId}/balances")
    public ResponseEntity<List<UserBalanceVO>> getUserBalances(@PathVariable Long userId);
}
```

### 5.2 游戏管理API
```java
@RestController
@RequestMapping("/api/games")
public class GameController {
    
    // 获取所有游戏
    @GetMapping
    public ResponseEntity<PageResult<GameVO>> getGames(@RequestParam(defaultValue = "1") int page,
                                                       @RequestParam(defaultValue = "10") int size);
    
    // 创建游戏
    @PostMapping
    public ResponseEntity<GameVO> createGame(@RequestBody CreateGameRequest request);
    
    // 发布游戏
    @PostMapping("/{gameId}/publish")
    public ResponseEntity<Void> publishGame(@PathVariable Long gameId);
    
    // 开始游戏
    @PostMapping("/{gameId}/play")
    public ResponseEntity<GameSessionVO> startGame(@PathVariable Long gameId);
    
    // 获取用户游戏
    @GetMapping("/user/{userId}")
    public ResponseEntity<List<GameVO>> getUserGames(@PathVariable Long userId);
}
```

### 5.3 智能体管理API
```java
@RestController
@RequestMapping("/api/agents")
public class AgentController {
    
    // 获取所有智能体
    @GetMapping
    public ResponseEntity<PageResult<AgentVO>> getAgents(@RequestParam(defaultValue = "1") int page,
                                                         @RequestParam(defaultValue = "10") int size);
    
    // 创建智能体
    @PostMapping
    public ResponseEntity<AgentVO> createAgent(@RequestBody CreateAgentRequest request);
    
    // 游戏制作智能体
    @PostMapping("/game-maker/generate")
    public ResponseEntity<GameGenerationResult> generateGame(@RequestBody GameGenerationRequest request);
    
    // 使用智能体
    @PostMapping("/{agentId}/use")
    public ResponseEntity<AgentUsageResult> useAgent(@PathVariable Long agentId, @RequestBody AgentUsageRequest request);
}
```

### 5.4 交易平台API
```java
@RestController
@RequestMapping("/api/marketplace")
public class MarketplaceController {
    
    // 获取市场商品
    @GetMapping("/items")
    public ResponseEntity<PageResult<MarketplaceItemVO>> getMarketplaceItems(
        @RequestParam(required = false) String itemType,
        @RequestParam(defaultValue = "1") int page,
        @RequestParam(defaultValue = "10") int size);
    
    // 上架商品
    @PostMapping("/items")
    public ResponseEntity<MarketplaceItemVO> listItem(@RequestBody ListItemRequest request);
    
    // 购买商品
    @PostMapping("/items/{itemId}/purchase")
    public ResponseEntity<TransactionVO> purchaseItem(@PathVariable Long itemId);
    
    // 获取交易历史
    @GetMapping("/transactions/user/{userId}")
    public ResponseEntity<List<TransactionVO>> getUserTransactions(@PathVariable Long userId);
}
```

### 5.5 支付充值API
```java
@RestController
@RequestMapping("/api/payment")
public class PaymentController {
    
    // 创建充值订单
    @PostMapping("/recharge")
    public ResponseEntity<RechargeOrderVO> createRechargeOrder(@RequestBody CreateRechargeRequest request);
    
    // 确认支付
    @PostMapping("/recharge/{orderId}/confirm")
    public ResponseEntity<Void> confirmPayment(@PathVariable Long orderId, @RequestBody ConfirmPaymentRequest request);
    
    // 获取充值记录
    @GetMapping("/recharge/user/{userId}")
    public ResponseEntity<List<RechargeRecordVO>> getRechargeRecords(@PathVariable Long userId);
}
```

## 6. 区块链智能合约设计

### 6.1 平台代币合约 (PlatformToken.sol)
```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import "@openzeppelin/contracts/access/Ownable.sol";

contract PlatformToken is ERC20, Ownable {
    constructor() ERC20("Platform Token", "PLT") {
        _mint(msg.sender, 1000000000 * 10**decimals()); // 初始发行10亿代币
    }
    
    // 充值功能
    function mint(address to, uint256 amount) public onlyOwner {
        _mint(to, amount);
    }
    
    // 消费功能
    function burn(uint256 amount) public {
        _burn(msg.sender, amount);
    }
}
```

### 6.2 游戏NFT合约 (GameNFT.sol)
```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "@openzeppelin/contracts/token/ERC721/ERC721.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/utils/Counters.sol";

contract GameNFT is ERC721, Ownable {
    using Counters for Counters.Counter;
    Counters.Counter private _tokenIds;
    
    struct Game {
        string title;
        string description;
        string codeHash; // IPFS hash
        address creator;
        uint256 createdAt;
    }
    
    mapping(uint256 => Game) public games;
    
    constructor() ERC721("Game NFT", "GAME") {}
    
    function createGame(
        address to,
        string memory title,
        string memory description,
        string memory codeHash
    ) public returns (uint256) {
        _tokenIds.increment();
        uint256 newTokenId = _tokenIds.current();
        
        _mint(to, newTokenId);
        
        games[newTokenId] = Game({
            title: title,
            description: description,
            codeHash: codeHash,
            creator: to,
            createdAt: block.timestamp
        });
        
        return newTokenId;
    }
}
```

### 6.3 智能体NFT合约 (AgentNFT.sol)
```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "@openzeppelin/contracts/token/ERC721/ERC721.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/utils/Counters.sol";

contract AgentNFT is ERC721, Ownable {
    using Counters for Counters.Counter;
    Counters.Counter private _tokenIds;
    
    struct Agent {
        string name;
        string description;
        string agentType;
        string codeHash; // IPFS hash
        string modelHash; // IPFS hash
        address creator;
        uint256 price;
        uint256 createdAt;
    }
    
    mapping(uint256 => Agent) public agents;
    
    constructor() ERC721("Agent NFT", "AGENT") {}
    
    function createAgent(
        address to,
        string memory name,
        string memory description,
        string memory agentType,
        string memory codeHash,
        string memory modelHash,
        uint256 price
    ) public returns (uint256) {
        _tokenIds.increment();
        uint256 newTokenId = _tokenIds.current();
        
        _mint(to, newTokenId);
        
        agents[newTokenId] = Agent({
            name: name,
            description: description,
            agentType: agentType,
            codeHash: codeHash,
            modelHash: modelHash,
            creator: to,
            price: price,
            createdAt: block.timestamp
        });
        
        return newTokenId;
    }
}
```

### 6.4 交易市场合约 (Marketplace.sol)
```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "@openzeppelin/contracts/token/ERC721/IERC721.sol";
import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";

contract Marketplace is ReentrancyGuard {
    IERC20 public platformToken;
    
    struct Listing {
        address seller;
        address nftContract;
        uint256 tokenId;
        uint256 price;
        bool active;
    }
    
    mapping(uint256 => Listing) public listings;
    uint256 public listingCounter;
    
    event ItemListed(uint256 indexed listingId, address indexed seller, address indexed nftContract, uint256 tokenId, uint256 price);
    event ItemSold(uint256 indexed listingId, address indexed buyer, uint256 price);
    
    constructor(address _platformToken) {
        platformToken = IERC20(_platformToken);
    }
    
    function listItem(address nftContract, uint256 tokenId, uint256 price) external {
        require(IERC721(nftContract).ownerOf(tokenId) == msg.sender, "Not owner");
        require(price > 0, "Price must be greater than 0");
        
        IERC721(nftContract).transferFrom(msg.sender, address(this), tokenId);
        
        listingCounter++;
        listings[listingCounter] = Listing({
            seller: msg.sender,
            nftContract: nftContract,
            tokenId: tokenId,
            price: price,
            active: true
        });
        
        emit ItemListed(listingCounter, msg.sender, nftContract, tokenId, price);
    }
    
    function buyItem(uint256 listingId) external nonReentrant {
        Listing storage listing = listings[listingId];
        require(listing.active, "Listing not active");
        require(platformToken.balanceOf(msg.sender) >= listing.price, "Insufficient balance");
        
        platformToken.transferFrom(msg.sender, listing.seller, listing.price);
        IERC721(listing.nftContract).transferFrom(address(this), msg.sender, listing.tokenId);
        
        listing.active = false;
        
        emit ItemSold(listingId, msg.sender, listing.price);
    }
}
```

## 7. 前端页面设计

### 7.1 页面结构
```
templates/
├── layout/
│   ├── base.html           # 基础模板
│   └── nav.html           # 导航栏组件
├── index.html             # 首页
├── auth/
│   ├── login.html         # 登录页
│   └── register.html      # 注册页
├── games/
│   ├── list.html          # 游戏列表
│   ├── detail.html        # 游戏详情
│   └── play.html          # 游戏页面
├── agents/
│   ├── list.html          # 智能体列表
│   ├── detail.html        # 智能体详情
│   ├── game-maker.html    # 游戏制作页面
│   └── upload.html        # 智能体上传
├── assets/
│   ├── dashboard.html     # 资产管理面板
│   ├── my-games.html      # 我的游戏
│   ├── my-agents.html     # 我的智能体
│   └── tokens.html        # 代币管理
├── marketplace/
│   ├── index.html         # 交易市场首页
│   ├── buy.html           # 购买页面
│   └── sell.html          # 出售页面
└── payment/
    ├── recharge.html      # 充值页面
    └── history.html       # 交易历史
```

### 7.2 基础模板 (base.html)
```html
<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} ?: '去中心化游戏平台'">去中心化游戏平台</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 自定义CSS -->
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <!-- Web3.js -->
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
</head>
<body>
    <!-- 导航栏 -->
    <nav th:replace="layout/nav :: nav"></nav>
    
    <!-- 主要内容区域 -->
    <main class="container-fluid py-4">
        <div th:replace="${content}"></div>
    </main>
    
    <!-- 页脚 -->
    <footer class="bg-dark text-light text-center py-3 mt-5">
        <div class="container">
            <p>&copy; 2024 去中心化游戏平台. All rights reserved.</p>
        </div>
    </footer>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 自定义JS -->
    <script th:src="@{/js/main.js}"></script>
</body>
</html>
```

### 7.3 导航栏组件 (nav.html)
```html
<nav th:fragment="nav" class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" th:href="@{/}">
            <i class="fas fa-gamepad me-2"></i>去中心化游戏平台
        </a>
        
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/}">首页</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/games}">游戏中心</a>
                </li>
            </ul>
            
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/agents}">
                        <i class="fas fa-robot me-1"></i>智能体平台
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/marketplace}">
                        <i class="fas fa-store me-1"></i>交易平台
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/assets}">
                        <i class="fas fa-wallet me-1"></i>资产管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/payment/recharge}">
                        <i class="fas fa-credit-card me-1"></i>充值
                    </a>
                </li>
                <li class="nav-item" th:if="${user == null}">
                    <button class="btn btn-outline-light" onclick="connectWallet()">
                        <i class="fas fa-plug me-1"></i>连接钱包
                    </button>
                </li>
                <li class="nav-item dropdown" th:if="${user != null}">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user me-1"></i><span th:text="${user.username}">用户</span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" th:href="@{/profile}">个人资料</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="disconnect()">断开连接</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>
```

### 7.4 首页 (index.html)
```html
<!DOCTYPE html>
<html th:replace="layout/base :: base(~{::title}, ~{::#content})">
<head>
    <title>首页 - 去中心化游戏平台</title>
</head>
<body>
    <div id="content">
        <!-- Hero Section -->
        <section class="hero-section bg-gradient-primary text-white py-5 mb-5">
            <div class="container text-center">
                <h1 class="display-4 fw-bold mb-4">欢迎来到去中心化游戏平台</h1>
                <p class="lead mb-4">体验AI驱动的游戏创作，享受区块链带来的真正资产所有权</p>
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="d-flex flex-wrap gap-3 justify-content-center">
                            <a th:href="@{/agents/game-maker}" class="btn btn-light btn-lg">
                                <i class="fas fa-magic me-2"></i>开始制作游戏
                            </a>
                            <a th:href="@{/marketplace}" class="btn btn-outline-light btn-lg">
                                <i class="fas fa-store me-2"></i>探索市场
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- 统计数据 -->
        <section class="stats-section mb-5">
            <div class="container">
                <div class="row text-center">
                    <div class="col-md-3 col-sm-6 mb-4">
                        <div class="stat-card">
                            <i class="fas fa-gamepad stat-icon text-primary"></i>
                            <h3 class="stat-number" th:text="${stats.totalGames}">0</h3>
                            <p class="stat-label">总游戏数</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-4">
                        <div class="stat-card">
                            <i class="fas fa-robot stat-icon text-success"></i>
                            <h3 class="stat-number" th:text="${stats.totalAgents}">0</h3>
                            <p class="stat-label">智能体数</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-4">
                        <div class="stat-card">
                            <i class="fas fa-users stat-icon text-info"></i>
                            <h3 class="stat-number" th:text="${stats.totalUsers}">0</h3>
                            <p class="stat-label">用户数</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-4">
                        <div class="stat-card">
                            <i class="fas fa-exchange-alt stat-icon text-warning"></i>
                            <h3 class="stat-number" th:text="${stats.totalTransactions}">0</h3>
                            <p class="stat-label">交易数</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- 热门游戏 -->
        <section class="popular-games mb-5">
            <div class="container">
                <h2 class="section-title text-center mb-5">热门游戏</h2>
                <div class="row">
                    <div class="col-lg-4 col-md-6 mb-4" th:each="game : ${popularGames}">
                        <div class="game-card">
                            <div class="game-image">
                                <img th:src="${game.imageUrl}" th:alt="${game.title}" class="img-fluid">
                                <div class="game-overlay">
                                    <a th:href="@{/games/{id}(id=${game.id})}" class="btn btn-primary">
                                        <i class="fas fa-play me-1"></i>开始游戏
                                    </a>
                                </div>
                            </div>
                            <div class="game-info p-3">
                                <h5 class="game-title" th:text="${game.title}">游戏标题</h5>
                                <p class="game-description" th:text="${game.description}">游戏描述</p>
                                <div class="game-meta d-flex justify-content-between align-items-center">
                                    <span class="play-count">
                                        <i class="fas fa-play-circle me-1"></i>
                                        <span th:text="${game.playCount}">0</span> 次游玩
                                    </span>
                                    <span class="rating">
                                        <i class="fas fa-star text-warning me-1"></i>
                                        <span th:text="${game.rating}">0.0</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-4">
                    <a th:href="@{/games}" class="btn btn-outline-primary btn-lg">
                        查看更多游戏 <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </section>
        
        <!-- 特色功能 -->
        <section class="features-section bg-light py-5">
            <div class="container">
                <h2 class="section-title text-center mb-5">平台特色</h2>
                <div class="row">
                    <div class="col-lg-4 mb-4">
                        <div class="feature-card text-center p-4">
                            <i class="fas fa-brain feature-icon text-primary mb-3"></i>
                            <h4>AI游戏制作</h4>
                            <p>只需一句话描述，AI智能体即可为您生成独特的游戏体验</p>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-4">
                        <div class="feature-card text-center p-4">
                            <i class="fas fa-shield-alt feature-icon text-success mb-3"></i>
                            <h4>区块链资产</h4>
                            <p>真正拥有您的数字资产，可自由交易，永不丢失</p>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-4">
                        <div class="feature-card text-center p-4">
                            <i class="fas fa-coins feature-icon text-warning mb-3"></i>
                            <h4>代币经济</h4>
                            <p>参与平台生态，获得代币奖励，享受价值增长</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</body>
</html>
```

## 8. 开发流程

### 8.1 环境搭建
1. **Java环境**：JDK 17+
2. **数据库**：MySQL 8.0+, Redis 7.0+
3. **区块链**：安装MetaMask，配置测试网络
4. **开发工具**：IntelliJ IDEA, Hardhat
5. **版本控制**：Git

### 8.2 开发步骤
1. **项目初始化**
   - 创建Spring Boot项目
   - 配置Maven依赖
   - 设置数据库连接

2. **数据库设计**
   - 创建数据库表结构
   - 配置MyBatis-Plus
   - 编写Mapper接口

3. **智能合约开发**
   - 使用Hardhat创建合约项目
   - 编写Solidity合约
   - 部署到测试网络

4. **后端API开发**
   - 创建实体类和DTO
   - 实现Service业务逻辑
   - 开发Controller接口

5. **前端页面开发**
   - 创建Thymeleaf模板
   - 实现Web3.js集成
   - 开发用户交互功能

6. **集成测试**
   - 单元测试
   - 集成测试
   - 端到端测试

### 8.3 部署流程
1. **测试环境部署**
   - Docker容器化
   - 测试网络部署
   - 功能验证

2. **生产环境部署**
   - 主网合约部署
   - 服务器配置
   - 域名和SSL证书

## 9. 安全考虑

### 9.1 智能合约安全
- **重入攻击防护**：使用ReentrancyGuard
- **权限控制**：实现基于角色的访问控制
- **代码审计**：第三方安全审计

### 9.2 Web应用安全
- **输入验证**：所有用户输入进行验证和清理
- **SQL注入防护**：使用参数化查询
- **XSS防护**：输出编码和CSP策略
- **CSRF防护**：使用CSRF Token

### 9.3 钱包安全
- **私钥管理**：用户私钥由钱包管理，平台不存储
- **签名验证**：所有交易需要用户签名确认
- **网络安全**：使用HTTPS加密通信

## 10. 监控和维护

### 10.1 系统监控
- **应用监控**：Spring Boot Actuator
- **数据库监控**：慢查询日志分析
- **区块链监控**：交易状态追踪

### 10.2 日志管理
- **应用日志**：Logback配置
- **访问日志**：Nginx访问日志
- **错误日志**：异常追踪和报警

### 10.3 备份策略
- **数据库备份**：定期全量和增量备份
- **代码备份**：Git版本控制
- **合约备份**：智能合约源码和ABI保存

## 11. 扩展计划

### 11.1 功能扩展
- **移动端应用**：开发React Native应用
- **多链支持**：支持BSC、Polygon等
- **NFT市场**：专门的NFT交易市场
- **社交功能**：用户社区和聊天

### 11.2 技术升级
- **微服务架构**：拆分为多个微服务
- **云原生部署**：Kubernetes部署
- **AI模型优化**：更强大的游戏生成AI
- **跨链桥接**：支持跨链资产转移

---

*本文档将随着项目开发进度持续更新和完善*
