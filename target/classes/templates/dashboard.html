<!DOCTYPE html>
<html th:replace="layout/base :: base(~{::title}, ~{::#content})">
<head>
    <title>用户中心 - 去中心化游戏平台</title>
    <style>
        .dashboard-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            margin-bottom: 1.5rem;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
        }

        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-color), #0056b3);
            color: white;
            padding: 2rem;
            border-radius: 15px 15px 0 0;
            text-align: center;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-item {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--secondary-color);
            font-size: 0.9rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--dark-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }

        .asset-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
        }

        .asset-item:hover {
            border-color: var(--primary-color);
            background-color: rgba(0,123,255,0.05);
        }

        .asset-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary-color), #0056b3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
            margin-right: 1rem;
        }

        .asset-info h6 {
            margin: 0;
            font-weight: 600;
        }

        .asset-info small {
            color: var(--secondary-color);
        }

        .asset-value {
            font-weight: bold;
            color: var(--success-color);
        }

        .game-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
        }

        .game-item:hover {
            border-color: var(--primary-color);
            background-color: rgba(0,123,255,0.05);
        }

        .game-thumbnail {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--info-color), #17a2b8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-right: 1rem;
        }

        .game-info h6 {
            margin: 0;
            font-weight: 600;
        }

        .game-info small {
            color: var(--secondary-color);
        }

        .game-status {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-published {
            background-color: var(--success-color);
            color: white;
        }

        .status-draft {
            background-color: var(--warning-color);
            color: white;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .action-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .action-icon {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .balance-display {
            background: linear-gradient(135deg, var(--success-color), #28a745);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 2rem;
        }

        .balance-amount {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .balance-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .recent-activity {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .activity-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e9ecef;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            color: var(--primary-color);
        }

        .activity-content {
            flex: 1;
        }

        .activity-time {
            color: var(--secondary-color);
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div id="content">
        <div class="container">
            <!-- 用户信息头部 -->
            <div class="dashboard-card">
                <div class="dashboard-header">
                    <div class="row align-items-center">
                        <div class="col-md-8 text-start">
                            <h2 class="mb-2">欢迎回来，<span th:text="${user.username}">用户</span>！</h2>
                            <p class="mb-0 opacity-75" th:text="'钱包地址: ' + ${user.walletAddress}">钱包地址</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="user-avatar">
                                <img th:src="${user.avatarUrl ?: '/images/default-avatar.png'}"
                                     alt="用户头像" class="rounded-circle" style="width: 80px; height: 80px;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 统计数据 -->
            <div class="dashboard-stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalGames">0</div>
                    <div class="stat-label">我的游戏</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalAgents">0</div>
                    <div class="stat-label">智能体</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalAssets">0</div>
                    <div class="stat-label">游戏资产</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalTransactions">0</div>
                    <div class="stat-label">交易次数</div>
                </div>
            </div>

            <!-- 代币余额 -->
            <div class="balance-display">
                <div class="balance-amount" id="tokenBalance">0.00 PLT</div>
                <div class="balance-label">平台代币余额</div>
                <div class="mt-3">
                    <a href="/payment/recharge" class="btn btn-light btn-sm">
                        <i class="fas fa-plus me-1"></i>充值
                    </a>
                    <a href="/assets" class="btn btn-outline-light btn-sm ms-2">
                        <i class="fas fa-eye me-1"></i>查看资产
                    </a>
                </div>
            </div>

            <div class="row">
                <!-- 快速操作 -->
                <div class="col-lg-6">
                    <div class="dashboard-card">
                        <h5 class="section-title">
                            <i class="fas fa-bolt me-2"></i>快速操作
                        </h5>
                        <div class="quick-actions">
                            <div class="action-card" onclick="window.location.href='/agents/game-maker'">
                                <div class="action-icon">
                                    <i class="fas fa-magic"></i>
                                </div>
                                <h6>AI游戏制作</h6>
                                <small class="text-muted">使用AI智能体创建游戏</small>
                            </div>
                            <div class="action-card" onclick="window.location.href='/marketplace'">
                                <div class="action-icon">
                                    <i class="fas fa-store"></i>
                                </div>
                                <h6>交易市场</h6>
                                <small class="text-muted">买卖游戏和智能体</small>
                            </div>
                            <div class="action-card" onclick="window.location.href='/assets'">
                                <div class="action-icon">
                                    <i class="fas fa-wallet"></i>
                                </div>
                                <h6>资产管理</h6>
                                <small class="text-muted">管理您的数字资产</small>
                            </div>
                            <div class="action-card" onclick="window.location.href='/games'">
                                <div class="action-icon">
                                    <i class="fas fa-gamepad"></i>
                                </div>
                                <h6>游戏中心</h6>
                                <small class="text-muted">发现精彩游戏</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 最近活动 -->
                <div class="col-lg-6">
                    <div class="dashboard-card">
                        <div class="recent-activity">
                            <h5 class="section-title">
                                <i class="fas fa-clock me-2"></i>最近活动
                            </h5>
                            <div id="recentActivity">
                                <div class="activity-item">
                                    <div class="activity-icon">
                                        <i class="fas fa-wallet"></i>
                                    </div>
                                    <div class="activity-content">
                                        <div>钱包连接成功</div>
                                        <div class="activity-time">刚刚</div>
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon">
                                        <i class="fas fa-coins"></i>
                                    </div>
                                    <div class="activity-content">
                                        <div>获得 100 PLT 奖励</div>
                                        <div class="activity-time">2小时前</div>
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon">
                                        <i class="fas fa-gamepad"></i>
                                    </div>
                                    <div class="activity-content">
                                        <div>游玩游戏《太空大战》</div>
                                        <div class="activity-time">1天前</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 我的游戏和资产 -->
            <div class="row">
                <!-- 我的游戏 -->
                <div class="col-lg-6">
                    <div class="dashboard-card">
                        <h5 class="section-title">
                            <i class="fas fa-gamepad me-2"></i>我的游戏
                        </h5>
                        <div id="myGames">
                            <div class="game-item">
                                <div class="game-thumbnail">
                                    <i class="fas fa-gamepad"></i>
                                </div>
                                <div class="game-info">
                                    <h6>太空大战</h6>
                                    <small>动作游戏 · 已发布</small>
                                </div>
                                <div class="game-status status-published">已发布</div>
                            </div>
                            <div class="game-item">
                                <div class="game-thumbnail">
                                    <i class="fas fa-puzzle-piece"></i>
                                </div>
                                <div class="game-info">
                                    <h6>魔法拼图</h6>
                                    <small>益智游戏 · 草稿</small>
                                </div>
                                <div class="game-status status-draft">草稿</div>
                            </div>
                            <div class="text-center py-3">
                                <a href="/games" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-eye me-1"></i>查看所有游戏
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 我的资产 -->
                <div class="col-lg-6">
                    <div class="dashboard-card">
                        <h5 class="section-title">
                            <i class="fas fa-gem me-2"></i>我的资产
                        </h5>
                        <div id="myAssets">
                            <div class="asset-item">
                                <div class="asset-icon">
                                    <i class="fas fa-coins"></i>
                                </div>
                                <div class="asset-info">
                                    <h6>平台代币</h6>
                                    <small>PLT</small>
                                </div>
                                <div class="asset-value">1,234.56</div>
                            </div>
                            <div class="asset-item">
                                <div class="asset-icon">
                                    <i class="fas fa-trophy"></i>
                                </div>
                                <div class="asset-info">
                                    <h6>稀有道具</h6>
                                    <small>黄金剑</small>
                                </div>
                                <div class="asset-value">传奇</div>
                            </div>
                            <div class="asset-item">
                                <div class="asset-icon">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div class="asset-info">
                                    <h6>智能体</h6>
                                    <small>游戏生成器</small>
                                </div>
                                <div class="asset-value">5 次</div>
                            </div>
                            <div class="text-center py-3">
                                <a href="/assets" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-eye me-1"></i>查看所有资产
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            loadDashboardData();
        });

        // 加载仪表板数据
        async function loadDashboardData() {
            try {
                // 加载用户统计数据
                await loadUserStats();

                // 加载用户余额
                await loadUserBalance();

                // 加载最近活动
                await loadRecentActivity();

            } catch (error) {
                console.error('加载仪表板数据失败:', error);
            }
        }

        // 加载用户统计数据
        async function loadUserStats() {
            try {
                const response = await fetch('/api/users/stats', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const stats = result.data;

                        document.getElementById('totalGames').textContent = stats.totalGames || 0;
                        document.getElementById('totalAgents').textContent = stats.totalAgents || 0;
                        document.getElementById('totalAssets').textContent = stats.totalAssets || 0;
                        document.getElementById('totalTransactions').textContent = stats.totalTransactions || 0;
                    }
                }
            } catch (error) {
                console.error('加载用户统计数据失败:', error);
            }
        }

        // 加载用户余额
        async function loadUserBalance() {
            try {
                const response = await fetch('/api/users/balance', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const balance = result.data;
                        document.getElementById('tokenBalance').textContent =
                            `${parseFloat(balance.balance || 0).toFixed(2)} ${balance.tokenType || 'PLT'}`;
                    }
                }
            } catch (error) {
                console.error('加载用户余额失败:', error);
            }
        }

        // 加载最近活动
        async function loadRecentActivity() {
            try {
                const response = await fetch('/api/users/activities', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const activities = result.data;

                        const activityContainer = document.getElementById('recentActivity');
                        activityContainer.innerHTML = '';

                        if (activities && activities.length > 0) {
                            activities.forEach(activity => {
                                const activityElement = document.createElement('div');
                                activityElement.className = 'activity-item';
                                activityElement.innerHTML = `
                                    <div class="activity-icon">
                                        <i class="fas ${getActivityIcon(activity.type)}"></i>
                                    </div>
                                    <div class="activity-content">
                                        <div>${activity.description}</div>
                                        <div class="activity-time">${formatTime(activity.createdAt)}</div>
                                    </div>
                                `;
                                activityContainer.appendChild(activityElement);
                            });
                        } else {
                            activityContainer.innerHTML = '<div class="text-center py-3 text-muted">暂无活动记录</div>';
                        }
                    }
                }
            } catch (error) {
                console.error('加载最近活动失败:', error);
            }
        }

        // 获取活动图标
        function getActivityIcon(type) {
            const iconMap = {
                'login': 'fa-sign-in-alt',
                'register': 'fa-user-plus',
                'game_play': 'fa-gamepad',
                'game_create': 'fa-plus',
                'transaction': 'fa-exchange-alt',
                'reward': 'fa-coins',
                'asset_purchase': 'fa-shopping-cart'
            };
            return iconMap[type] || 'fa-info-circle';
        }

        // 格式化时间
        function formatTime(timestamp) {
            if (!timestamp) return '未知时间';

            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return '刚刚';
            if (minutes < 60) return `${minutes}分钟前`;
            if (hours < 24) return `${hours}小时前`;
            if (days < 7) return `${days}天前`;

            return date.toLocaleDateString();
        }

        // 检查用户登录状态
        async function checkAuthStatus() {
            const token = localStorage.getItem('accessToken');
            const user = localStorage.getItem('user');

            if (!token || !user) {
                // 未登录，跳转到登录页面
                window.location.href = '/auth/login';
                return;
            }

            try {
                // 从服务器获取最新用户信息
                const response = await fetch('/api/users/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const userData = result.data;
                        // 更新本地存储
                        localStorage.setItem('user', JSON.stringify(userData));
                        // 更新页面用户信息
                        updateUserInfo(userData);
                    }
                } else {
                    // 令牌可能过期，跳转到登录页面
                    window.location.href = '/auth/login';
                }
            } catch (error) {
                console.error('检查登录状态失败:', error);
                window.location.href = '/auth/login';
            }
        }

        // 更新用户信息显示
        function updateUserInfo(userData) {
            if (userData.username) {
                document.querySelector('.dashboard-header h2').innerHTML =
                    `欢迎回来，<span>${userData.username}</span>！`;
            }
            if (userData.walletAddress) {
                document.querySelector('.dashboard-header p').textContent =
                    `钱包地址: ${userData.walletAddress}`;
            }
            if (userData.avatarUrl) {
                document.querySelector('.user-avatar img').src = userData.avatarUrl;
            }
        }

    </script>
</body>
</html>
