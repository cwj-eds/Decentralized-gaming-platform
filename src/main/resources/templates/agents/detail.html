<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
	<title th:text="${agent.name} + ' - 智能体详情'">智能体详情</title>
</head>
<body>
	<div th:replace="~{layout/base :: base(${agent.name} + ' - 智能体详情', ~{::#content})}">
		<div id="content">
			<div class="container mt-4">
				<div class="row">
					<!-- 智能体基本信息 -->
					<div class="col-lg-8">
						<div class="card shadow-sm mb-4">
							<div class="card-body">
								<div class="d-flex align-items-center mb-4">
									<div class="agent-avatar me-4">
										<i class="fas fa-robot fa-4x text-primary"></i>
									</div>
									<div class="flex-grow-1">
										<h1 class="h2 mb-2" th:text="${agent.name}">智能体名称</h1>
										<div class="d-flex align-items-center mb-2">
											<span class="badge bg-primary me-2" th:text="${agent.agentType}">智能体类型</span>
											<span class="badge bg-success" th:if="${agent.status.name() == 'ACTIVE'}">活跃</span>
											<span class="badge bg-secondary" th:if="${agent.status.name() == 'INACTIVE'}">非活跃</span>
											<span class="badge bg-danger" th:if="${agent.status.name() == 'BANNED'}">已禁用</span>
										</div>
										<div class="agent-meta">
											<small class="text-muted">
												<i class="fas fa-user me-1"></i>创建者: <span th:text="${agent.creatorName}">创建者</span>
												<span class="ms-3">
													<i class="fas fa-calendar me-1"></i>创建时间: 
													<span th:text="${#temporals.format(agent.createdAt, 'yyyy-MM-dd HH:mm')}">创建时间</span>
												</span>
											</small>
										</div>
									</div>
									<div class="agent-price" th:if="${agent.price > 0}">
										<div class="text-end">
											<div class="h4 text-success mb-0" th:text="'¥' + ${agent.price}">¥0</div>
											<small class="text-muted">使用费用</small>
										</div>
									</div>
								</div>

								<div class="agent-description">
									<h5>智能体描述</h5>
									<p class="text-muted" th:text="${agent.description}">智能体描述内容</p>
								</div>
							</div>
						</div>

						<!-- 智能体统计信息 -->
						<div class="card shadow-sm mb-4">
							<div class="card-header">
								<h5 class="mb-0">
									<i class="fas fa-chart-bar me-2"></i>统计信息
								</h5>
							</div>
							<div class="card-body">
								<div class="row text-center">
									<div class="col-md-3 mb-3">
										<div class="stat-item">
											<i class="fas fa-play fa-2x text-primary mb-2"></i>
											<div class="h4 mb-1" th:text="${agent.usageCount}">0</div>
											<div class="text-muted">使用次数</div>
										</div>
									</div>
									<div class="col-md-3 mb-3">
										<div class="stat-item">
											<i class="fas fa-star fa-2x text-warning mb-2"></i>
											<div class="h4 mb-1" th:text="${agent.rating}">0.0</div>
											<div class="text-muted">评分</div>
										</div>
									</div>
									<div class="col-md-3 mb-3">
										<div class="stat-item">
											<i class="fas fa-calendar fa-2x text-info mb-2"></i>
											<div class="h4 mb-1" th:text="${#temporals.format(agent.createdAt, 'MM-dd')}">创建日期</div>
											<div class="text-muted">创建日期</div>
										</div>
									</div>
									<div class="col-md-3 mb-3">
										<div class="stat-item">
											<i class="fas fa-clock fa-2x text-success mb-2"></i>
											<div class="h4 mb-1" th:text="${#temporals.format(agent.updatedAt, 'MM-dd')}">更新时间</div>
											<div class="text-muted">更新时间</div>
										</div>
									</div>
								</div>
							</div>
						</div>

						<!-- 技术信息 -->
						<div class="card shadow-sm" th:if="${agent.codeUrl != null or agent.modelUrl != null or agent.contractAddress != null}">
							<div class="card-header">
								<h5 class="mb-0">
									<i class="fas fa-cogs me-2"></i>技术信息
								</h5>
							</div>
							<div class="card-body">
								<div class="row">
									<div class="col-md-4 mb-3" th:if="${agent.codeUrl != null}">
										<strong>代码地址:</strong>
										<div class="text-break">
											<a th:href="${agent.codeUrl}" target="_blank" class="text-decoration-none">
												<i class="fas fa-external-link-alt me-1"></i>查看代码
											</a>
										</div>
									</div>
									<div class="col-md-4 mb-3" th:if="${agent.modelUrl != null}">
										<strong>模型地址:</strong>
										<div class="text-break">
											<a th:href="${agent.modelUrl}" target="_blank" class="text-decoration-none">
												<i class="fas fa-external-link-alt me-1"></i>查看模型
											</a>
										</div>
									</div>
									<div class="col-md-4 mb-3" th:if="${agent.contractAddress != null}">
										<strong>合约地址:</strong>
										<div class="text-break">
											<code th:text="${agent.contractAddress}">合约地址</code>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- 侧边栏 -->
					<div class="col-lg-4">
						<!-- 操作按钮 -->
						<div class="card shadow-sm mb-4">
							<div class="card-header">
								<h5 class="mb-0">
									<i class="fas fa-tools me-2"></i>操作
								</h5>
							</div>
							<div class="card-body">
								<div class="d-grid gap-2">
									<button class="btn btn-primary" th:onclick="'useAgent(' + ${agent.id} + ')'" 
											th:if="${agent.status.name() == 'ACTIVE'}">
										<i class="fas fa-play me-2"></i>使用智能体
									</button>
									<button class="btn btn-outline-secondary" disabled th:if="${agent.status.name() != 'ACTIVE'}">
										<i class="fas fa-ban me-2"></i>智能体不可用
									</button>
									<a th:href="@{/agents/list}" class="btn btn-outline-primary">
										<i class="fas fa-arrow-left me-2"></i>返回列表
									</a>
								</div>
							</div>
						</div>

						<!-- 创建者信息 -->
						<div class="card shadow-sm mb-4">
							<div class="card-header">
								<h5 class="mb-0">
									<i class="fas fa-user me-2"></i>创建者
								</h5>
							</div>
							<div class="card-body">
								<div class="d-flex align-items-center">
									<div class="creator-avatar me-3">
										<i class="fas fa-user-circle fa-2x text-muted"></i>
									</div>
									<div>
										<h6 class="mb-1" th:text="${agent.creatorName}">创建者名称</h6>
										<small class="text-muted">智能体开发者</small>
									</div>
								</div>
							</div>
						</div>

						<!-- 相关智能体 -->
						<div class="card shadow-sm">
							<div class="card-header">
								<h5 class="mb-0">
									<i class="fas fa-robot me-2"></i>相关智能体
								</h5>
							</div>
							<div class="card-body">
								<div class="related-agents">
									<div class="related-agent-item mb-3">
										<div class="d-flex align-items-center">
											<i class="fas fa-robot text-primary me-2"></i>
											<div class="flex-grow-1">
												<h6 class="mb-1">AI对话助手</h6>
												<small class="text-muted">智能对话智能体</small>
											</div>
											<a href="/agents/2" class="btn btn-sm btn-outline-primary">查看</a>
										</div>
									</div>
									<div class="related-agent-item mb-3">
										<div class="d-flex align-items-center">
											<i class="fas fa-robot text-success me-2"></i>
											<div class="flex-grow-1">
												<h6 class="mb-1">数据分析师</h6>
												<small class="text-muted">数据分析智能体</small>
											</div>
											<a href="/agents/3" class="btn btn-sm btn-outline-primary">查看</a>
										</div>
									</div>
									<div class="text-center">
										<a th:href="@{/agents/list}" class="btn btn-outline-primary btn-sm">
											查看更多智能体
										</a>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- JavaScript -->
	<script th:inline="javascript">
		function useAgent(agentId) {
			// 这里应该从session或token中获取用户ID
			const userId = 1; // 临时硬编码，实际应该从认证信息中获取
			
			// 显示加载状态
			const button = event.target;
			const originalText = button.innerHTML;
			button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>使用中...';
			button.disabled = true;
			
			fetch('/agents/api/' + agentId + '/use?userId=' + userId, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				}
			})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					// 显示成功消息
					showAlert('success', '智能体使用成功！');
					// 刷新页面以更新使用次数
					setTimeout(() => {
						location.reload();
					}, 1500);
				} else {
					showAlert('danger', '使用失败: ' + data.message);
				}
			})
			.catch(error => {
				console.error('Error:', error);
				showAlert('danger', '使用失败，请稍后重试');
			})
			.finally(() => {
				// 恢复按钮状态
				button.innerHTML = originalText;
				button.disabled = false;
			});
		}

		function showAlert(type, message) {
			// 创建提示框
			const alertDiv = document.createElement('div');
			alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
			alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
			alertDiv.innerHTML = `
				${message}
				<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
			`;
			
			document.body.appendChild(alertDiv);
			
			// 3秒后自动消失
			setTimeout(() => {
				if (alertDiv.parentNode) {
					alertDiv.parentNode.removeChild(alertDiv);
				}
			}, 3000);
		}
	</script>
</body>
</html>

