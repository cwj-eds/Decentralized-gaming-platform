<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
	<title>游戏制作智能体 - 智能体平台</title>
</head>
<body>
	<div th:replace="~{layout/base :: base('游戏制作智能体 - 智能体平台', ~{::#content})}">
		<div id="content">
			<div class="container mt-4">
				<!-- 页面标题 -->
				<div class="text-center mb-5">
					<h1 class="display-5 fw-bold">
						<i class="fas fa-magic text-primary me-3"></i>游戏制作智能体
					</h1>
					<p class="lead text-muted">只需一句话描述，AI智能体即可为您生成独特的游戏体验</p>
				</div>

				<div class="row">
					<!-- 游戏生成表单 -->
					<div class="col-lg-8">
						<div class="card shadow-sm">
							<div class="card-header bg-primary text-white">
								<h4 class="mb-0">
									<i class="fas fa-gamepad me-2"></i>创建您的游戏
								</h4>
							</div>
							<div class="card-body">
								<form id="gameGenerationForm">
									<div class="mb-4">
										<label for="description" class="form-label fw-bold">
											<i class="fas fa-comment me-1"></i>游戏描述
										</label>
										<textarea class="form-control" id="description" name="description" rows="4" 
												  placeholder="请详细描述您想要创建的游戏，例如：创建一个太空射击游戏，玩家控制飞船躲避陨石并射击敌人，包含多种武器和道具系统..." 
												  required></textarea>
										<div class="form-text">越详细的描述，AI生成的游戏质量越高</div>
									</div>

									<div class="row">
										<div class="col-md-4 mb-3">
											<label for="gameType" class="form-label fw-bold">
												<i class="fas fa-tags me-1"></i>游戏类型
											</label>
											<select class="form-select" id="gameType" name="gameType">
												<option value="">请选择游戏类型</option>
												<option value="ACTION">动作游戏</option>
												<option value="PUZZLE">解谜游戏</option>
												<option value="STRATEGY">策略游戏</option>
												<option value="RACING">竞速游戏</option>
												<option value="ADVENTURE">冒险游戏</option>
												<option value="CASUAL">休闲游戏</option>
											</select>
										</div>
										<div class="col-md-4 mb-3">
											<label for="difficulty" class="form-label fw-bold">
												<i class="fas fa-signal me-1"></i>游戏难度
											</label>
											<select class="form-select" id="difficulty" name="difficulty">
												<option value="">请选择难度</option>
												<option value="EASY">简单</option>
												<option value="MEDIUM">中等</option>
												<option value="HARD">困难</option>
											</select>
										</div>
										<div class="col-md-4 mb-3">
											<label for="theme" class="form-label fw-bold">
												<i class="fas fa-palette me-1"></i>游戏主题
											</label>
											<select class="form-select" id="theme" name="theme">
												<option value="">请选择主题</option>
												<option value="SPACE">太空</option>
												<option value="FANTASY">奇幻</option>
												<option value="SCIFI">科幻</option>
												<option value="MEDIEVAL">中世纪</option>
												<option value="MODERN">现代</option>
												<option value="ANIME">动漫</option>
											</select>
										</div>
									</div>

									<div class="mb-4">
										<label for="specialRequirements" class="form-label fw-bold">
											<i class="fas fa-star me-1"></i>特殊要求
										</label>
										<textarea class="form-control" id="specialRequirements" name="specialRequirements" rows="2" 
												  placeholder="如有特殊要求，请在此说明（可选）"></textarea>
									</div>

									<div class="d-grid">
										<button type="submit" class="btn btn-primary btn-lg" id="generateBtn">
											<i class="fas fa-magic me-2"></i>开始生成游戏
										</button>
									</div>
								</form>
							</div>
						</div>
					</div>

					<!-- 侧边栏 -->
					<div class="col-lg-4">
						<!-- 生成进度 -->
						<div class="card mb-4" id="progressCard" style="display: none;">
							<div class="card-header">
								<h5 class="mb-0">
									<i class="fas fa-cog fa-spin me-2"></i>生成进度
								</h5>
							</div>
							<div class="card-body">
								<div class="progress mb-3">
									<div class="progress-bar progress-bar-striped progress-bar-animated" 
										 role="progressbar" style="width: 0%" id="progressBar"></div>
								</div>
								<p class="mb-0" id="progressText">正在分析您的需求...</p>
							</div>
						</div>

						<!-- 生成结果 -->
						<div class="card mb-4" id="resultCard" style="display: none;">
							<div class="card-header bg-success text-white">
								<h5 class="mb-0">
									<i class="fas fa-check-circle me-2"></i>生成完成
								</h5>
							</div>
							<div class="card-body">
								<div id="resultContent"></div>
							</div>
						</div>

						<!-- 示例游戏 -->
						<div class="card mb-4">
							<div class="card-header">
								<h5 class="mb-0">
									<i class="fas fa-lightbulb me-2"></i>示例描述
								</h5>
							</div>
							<div class="card-body">
								<div class="example-item mb-3">
									<strong>太空射击游戏：</strong>
									<p class="small text-muted mb-1">创建一个太空射击游戏，玩家控制飞船在太空中飞行，躲避陨石和敌人攻击，收集道具升级武器。</p>
									<button class="btn btn-sm btn-outline-primary" onclick="fillExample('space')">使用此示例</button>
								</div>
								<div class="example-item mb-3">
									<strong>跑酷游戏：</strong>
									<p class="small text-muted mb-1">制作一个跑酷游戏，角色在障碍物间跳跃奔跑，收集金币，避开陷阱，挑战最高分数。</p>
									<button class="btn btn-sm btn-outline-primary" onclick="fillExample('parkour')">使用此示例</button>
								</div>
								<div class="example-item">
									<strong>解谜游戏：</strong>
									<p class="small text-muted mb-1">设计一个逻辑解谜游戏，玩家需要通过移动方块、旋转机关等方式解决谜题，包含多个关卡。</p>
									<button class="btn btn-sm btn-outline-primary" onclick="fillExample('puzzle')">使用此示例</button>
								</div>
							</div>
						</div>

						<!-- 智能体信息 -->
						<div class="card">
							<div class="card-header">
								<h5 class="mb-0">
									<i class="fas fa-robot me-2"></i>游戏制作智能体
								</h5>
							</div>
							<div class="card-body">
								<div class="agent-info">
									<div class="d-flex align-items-center mb-3">
										<i class="fas fa-robot fa-2x text-primary me-3"></i>
										<div>
											<h6 class="mb-1">AI游戏制作师</h6>
											<small class="text-muted">专业游戏生成智能体</small>
										</div>
									</div>
									<div class="agent-stats">
										<div class="row text-center">
											<div class="col-6">
												<div class="stat-item">
													<div class="stat-number text-primary" th:text="${gameMakerAgents.size()}">0</div>
													<div class="stat-label">可用智能体</div>
												</div>
											</div>
											<div class="col-6">
												<div class="stat-item">
													<div class="stat-number text-success">100%</div>
													<div class="stat-label">成功率</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- JavaScript -->
	<script th:inline="javascript">
		document.getElementById('gameGenerationForm').addEventListener('submit', function(e) {
			e.preventDefault();
			generateGame();
		});

		function generateGame() {
			const form = document.getElementById('gameGenerationForm');
			const formData = new FormData(form);
			
			// 显示进度卡片
			document.getElementById('progressCard').style.display = 'block';
			document.getElementById('resultCard').style.display = 'none';
			document.getElementById('generateBtn').disabled = true;
			
			// 模拟进度更新
			simulateProgress();
			
		// 发送请求
		const requestData = {
			description: formData.get('description'),
			gameType: formData.get('gameType'),
			difficulty: formData.get('difficulty'),
			theme: formData.get('theme'),
			specialRequirements: formData.get('specialRequirements')
		};
		
		// ✅ 不需要手动传递userId，后端会自动从JWT token中获取当前登录用户ID
		// JWT token已经在登录时设置为HttpOnly Cookie，会自动随请求发送
		
		fetch('/agents/api/game-maker/generate', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify(requestData)
		})
			.then(response => response.json())
			.then(data => {
				hideProgress();
				if (data.success) {
					showResult(data.data);
				} else {
					showError(data.message);
				}
			})
			.catch(error => {
				hideProgress();
				showError('生成失败，请稍后重试');
				console.error('Error:', error);
			});
		}

		function simulateProgress() {
			const progressBar = document.getElementById('progressBar');
			const progressText = document.getElementById('progressText');
			const steps = [
				{ width: 20, text: '正在分析您的需求...' },
				{ width: 40, text: '设计游戏架构...' },
				{ width: 60, text: '生成游戏代码...' },
				{ width: 80, text: '优化游戏逻辑...' },
				{ width: 100, text: '生成完成！' }
			];
			
			let currentStep = 0;
			const interval = setInterval(() => {
				if (currentStep < steps.length) {
					progressBar.style.width = steps[currentStep].width + '%';
					progressText.textContent = steps[currentStep].text;
					currentStep++;
				} else {
					clearInterval(interval);
				}
			}, 1000);
		}

		function hideProgress() {
			document.getElementById('progressCard').style.display = 'none';
			document.getElementById('generateBtn').disabled = false;
		}

		function showResult(result) {
			const resultCard = document.getElementById('resultCard');
			const resultContent = document.getElementById('resultContent');
			
			resultContent.innerHTML = `
				<div class="alert alert-success">
					<h6><i class="fas fa-check-circle me-2"></i>游戏生成成功！</h6>
					<p class="mb-2">游戏标题：<strong>${result.gameTitle}</strong></p>
					<p class="mb-3">游戏ID：${result.gameId}</p>
				</div>
				<div class="d-grid gap-2">
					<a href="/games/${result.gameId}" class="btn btn-primary">
						<i class="fas fa-play me-2"></i>查看游戏
					</a>
					<a href="/games/${result.gameId}/play" class="btn btn-success">
						<i class="fas fa-gamepad me-2"></i>开始游戏
					</a>
				</div>
			`;
			
			resultCard.style.display = 'block';
		}

		function showError(message) {
			const resultCard = document.getElementById('resultCard');
			const resultContent = document.getElementById('resultContent');
			
			resultContent.innerHTML = `
				<div class="alert alert-danger">
					<h6><i class="fas fa-exclamation-triangle me-2"></i>生成失败</h6>
					<p class="mb-0">${message}</p>
				</div>
			`;
			
			resultCard.style.display = 'block';
		}

		function fillExample(type) {
			const examples = {
				space: {
					description: '创建一个太空射击游戏，玩家控制飞船在太空中飞行，躲避陨石和敌人攻击，收集道具升级武器，包含多种敌人类型和Boss战。',
					gameType: 'ACTION',
					difficulty: 'MEDIUM',
					theme: 'SPACE'
				},
				parkour: {
					description: '制作一个跑酷游戏，角色在障碍物间跳跃奔跑，收集金币，避开陷阱，挑战最高分数，包含多种地形和特殊道具。',
					gameType: 'ACTION',
					difficulty: 'EASY',
					theme: 'MODERN'
				},
				puzzle: {
					description: '设计一个逻辑解谜游戏，玩家需要通过移动方块、旋转机关等方式解决谜题，包含多个关卡，难度逐渐递增。',
					gameType: 'PUZZLE',
					difficulty: 'MEDIUM',
					theme: 'FANTASY'
				}
			};
			
			const example = examples[type];
			document.getElementById('description').value = example.description;
			document.getElementById('gameType').value = example.gameType;
			document.getElementById('difficulty').value = example.difficulty;
			document.getElementById('theme').value = example.theme;
		}
	</script>
</body>
</html>