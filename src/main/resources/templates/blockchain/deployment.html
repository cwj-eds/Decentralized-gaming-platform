<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能合约部署 - 去中心化游戏平台</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- 自定义CSS -->
    <link rel="stylesheet" th:href="@{/css/main.css}">
    
    <style>
        .deployment-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }
        
        .deployment-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .contract-status {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .contract-status.deployed {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }
        
        .contract-status.not-deployed {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }
        
        .contract-status.pending {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
        }
        
        .deployment-progress {
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.3);
            overflow: hidden;
        }
        
        .deployment-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            transition: width 0.5s ease;
        }
        
        .deploy-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .deploy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
            color: white;
        }
        
        .deploy-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .status-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 1.2rem;
        }
        
        .status-icon.deployed {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .status-icon.not-deployed {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .status-icon.pending {
            background: rgba(255, 255, 255, 0.2);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .contract-info {
            flex: 1;
        }
        
        .contract-address {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            background: rgba(0, 0, 0, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 5px;
            word-break: break-all;
        }
        
        .deployment-log {
            background: #1e1e1e;
            color: #00ff00;
            border-radius: 10px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
        }
        
        .log-entry {
            margin: 0.25rem 0;
        }
        
        .log-entry.success {
            color: #00ff00;
        }
        
        .log-entry.error {
            color: #ff0000;
        }
        
        .log-entry.info {
            color: #00bfff;
        }
    </style>
</head>
<body>
    <div class="deployment-container">
        <div class="container">
            <!-- 页面标题 -->
            <div class="row mb-4">
                <div class="col-12 text-center">
                    <h1 class="text-white mb-3">
                        <i class="fas fa-cube me-3"></i>智能合约部署中心
                    </h1>
                    <p class="text-white-50">部署和管理去中心化游戏平台的智能合约</p>
                </div>
            </div>

            <!-- 部署状态概览 -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="deployment-card p-4">
                        <h3 class="mb-4">
                            <i class="fas fa-chart-pie me-2"></i>部署状态概览
                        </h3>
                        
                        <!-- 部署进度 -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>部署进度</span>
                                <span id="deploymentProgress">0%</span>
                            </div>
                            <div class="deployment-progress">
                                <div class="deployment-progress-bar" id="progressBar" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- 合约状态列表 -->
                        <div id="contractStatusList">
                            <!-- 动态加载合约状态 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 部署操作区域 -->
            <div class="row">
                <!-- 单个合约部署 -->
                <div class="col-lg-6 mb-4">
                    <div class="deployment-card p-4">
                        <h3 class="mb-4">
                            <i class="fas fa-rocket me-2"></i>单个合约部署
                        </h3>
                        
                        <form id="singleDeploymentForm">
                            <div class="mb-3">
                                <label class="form-label">部署者私钥</label>
                                <input type="password" class="form-control" id="deployerPrivateKey" 
                                       placeholder="输入部署者私钥" required>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">合约类型</label>
                                <select class="form-control" id="contractType" required>
                                    <option value="">选择合约类型</option>
                                    <option value="platform-token">平台代币合约</option>
                                    <option value="game-nft">游戏NFT合约</option>
                                    <option value="agent-nft">智能体NFT合约</option>
                                    <option value="marketplace">交易市场合约</option>
                                    <option value="rewards">奖励合约</option>
                                </select>
                            </div>
                            
                            <div id="contractSpecificFields">
                                <!-- 根据合约类型动态显示字段 -->
                            </div>
                            
                            <button type="submit" class="btn deploy-btn w-100">
                                <i class="fas fa-play me-2"></i>部署合约
                            </button>
                        </form>
                    </div>
                </div>

                <!-- 批量部署 -->
                <div class="col-lg-6 mb-4">
                    <div class="deployment-card p-4">
                        <h3 class="mb-4">
                            <i class="fas fa-layer-group me-2"></i>批量部署所有合约
                        </h3>
                        
                        <form id="batchDeploymentForm">
                            <div class="mb-3">
                                <label class="form-label">部署者私钥</label>
                                <input type="password" class="form-control" id="batchDeployerPrivateKey" 
                                       placeholder="输入部署者私钥" required>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">费用接收者地址</label>
                                <input type="text" class="form-control" id="feeRecipient" 
                                       placeholder="输入费用接收者地址" required>
                            </div>
                            
                            <div class="row">
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label class="form-label">游戏创建费用 (PLT)</label>
                                        <input type="number" class="form-control" id="gameCreationFee" 
                                               value="100" min="0" step="1">
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label class="form-label">智能体创建费用 (PLT)</label>
                                        <input type="number" class="form-control" id="agentCreationFee" 
                                               value="50" min="0" step="1">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">市场手续费率 (%)</label>
                                <input type="number" class="form-control" id="marketplaceFeeRate" 
                                       value="2.5" min="0" max="10" step="0.1">
                            </div>
                            
                            <button type="submit" class="btn deploy-btn w-100">
                                <i class="fas fa-magic me-2"></i>批量部署所有合约
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 部署日志 -->
            <div class="row">
                <div class="col-12">
                    <div class="deployment-card p-4">
                        <h3 class="mb-4">
                            <i class="fas fa-terminal me-2"></i>部署日志
                        </h3>
                        <div class="deployment-log" id="deploymentLog">
                            <div class="log-entry info">等待部署操作...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 自定义JS -->
    <script th:src="@{/js/main.js}"></script>
    
    <script>
        // 部署状态数据
        let deploymentStatus = {
            platformTokenDeployed: false,
            gameNFTDeployed: false,
            agentNFTDeployed: false,
            marketplaceDeployed: false,
            rewardsDeployed: false,
            platformTokenAddress: '',
            gameNFTAddress: '',
            agentNFTAddress: '',
            marketplaceAddress: '',
            rewardsAddress: ''
        };

        // 页面加载时获取部署状态
        document.addEventListener('DOMContentLoaded', function() {
            loadDeploymentStatus();
            setupEventListeners();
        });

        // 设置事件监听器
        function setupEventListeners() {
            // 单个合约部署表单
            document.getElementById('singleDeploymentForm').addEventListener('submit', handleSingleDeployment);
            
            // 批量部署表单
            document.getElementById('batchDeploymentForm').addEventListener('submit', handleBatchDeployment);
            
            // 合约类型变化
            document.getElementById('contractType').addEventListener('change', updateContractSpecificFields);
        }

        // 加载部署状态
        async function loadDeploymentStatus() {
            try {
                const response = await fetch('/api/blockchain/deployment/status');
                const result = await response.json();
                
                if (result.code === 200) {
                    deploymentStatus = result.data;
                    updateDeploymentStatusDisplay();
                } else {
                    addLogEntry('error', '获取部署状态失败: ' + result.message);
                }
            } catch (error) {
                addLogEntry('error', '获取部署状态时发生错误: ' + error.message);
            }
        }

        // 更新部署状态显示
        function updateDeploymentStatusDisplay() {
            const contracts = [
                { type: 'platform-token', name: '平台代币合约', deployed: deploymentStatus.platformTokenDeployed, address: deploymentStatus.platformTokenAddress },
                { type: 'game-nft', name: '游戏NFT合约', deployed: deploymentStatus.gameNFTDeployed, address: deploymentStatus.gameNFTAddress },
                { type: 'agent-nft', name: '智能体NFT合约', deployed: deploymentStatus.agentNFTDeployed, address: deploymentStatus.agentNFTAddress },
                { type: 'marketplace', name: '交易市场合约', deployed: deploymentStatus.marketplaceDeployed, address: deploymentStatus.marketplaceAddress },
                { type: 'rewards', name: '奖励合约', deployed: deploymentStatus.rewardsDeployed, address: deploymentStatus.rewardsAddress }
            ];

            const statusList = document.getElementById('contractStatusList');
            statusList.innerHTML = '';

            contracts.forEach(contract => {
                const statusDiv = document.createElement('div');
                statusDiv.className = `contract-status ${contract.deployed ? 'deployed' : 'not-deployed'}`;
                
                const iconClass = contract.deployed ? 'fas fa-check-circle' : 'fas fa-times-circle';
                const statusText = contract.deployed ? '已部署' : '未部署';
                
                statusDiv.innerHTML = `
                    <div class="status-icon ${contract.deployed ? 'deployed' : 'not-deployed'}">
                        <i class="${iconClass}"></i>
                    </div>
                    <div class="contract-info">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-1">${contract.name}</h6>
                            <span class="badge ${contract.deployed ? 'bg-success' : 'bg-danger'}">${statusText}</span>
                        </div>
                        ${contract.deployed && contract.address ? 
                            `<div class="contract-address">${contract.address}</div>` : 
                            '<div class="text-muted">未部署</div>'
                        }
                    </div>
                `;
                
                statusList.appendChild(statusDiv);
            });

            // 更新进度条
            const deployedCount = contracts.filter(c => c.deployed).length;
            const progress = (deployedCount / contracts.length) * 100;
            document.getElementById('deploymentProgress').textContent = Math.round(progress) + '%';
            document.getElementById('progressBar').style.width = progress + '%';
        }

        // 更新合约特定字段
        function updateContractSpecificFields() {
            const contractType = document.getElementById('contractType').value;
            const fieldsContainer = document.getElementById('contractSpecificFields');
            
            fieldsContainer.innerHTML = '';
            
            if (contractType === 'platform-token') {
                fieldsContainer.innerHTML = `
                    <div class="mb-3">
                        <label class="form-label">代币名称</label>
                        <input type="text" class="form-control" name="name" value="Platform Token" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">代币符号</label>
                        <input type="text" class="form-control" name="symbol" value="PLT" required>
                    </div>
                `;
            } else if (contractType === 'game-nft' || contractType === 'agent-nft') {
                const contractName = contractType === 'game-nft' ? 'Game NFT' : 'Agent NFT';
                const contractSymbol = contractType === 'game-nft' ? 'GAME' : 'AGENT';
                
                fieldsContainer.innerHTML = `
                    <div class="mb-3">
                        <label class="form-label">NFT名称</label>
                        <input type="text" class="form-control" name="name" value="${contractName}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">NFT符号</label>
                        <input type="text" class="form-control" name="symbol" value="${contractSymbol}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">平台代币地址</label>
                        <input type="text" class="form-control" name="platformTokenAddress" 
                               value="${deploymentStatus.platformTokenAddress}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">费用接收者地址</label>
                        <input type="text" class="form-control" name="feeRecipient" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">创建费用 (PLT)</label>
                        <input type="number" class="form-control" name="creationFee" 
                               value="${contractType === 'game-nft' ? '100' : '50'}" min="0" step="1" required>
                    </div>
                `;
            } else if (contractType === 'marketplace') {
                fieldsContainer.innerHTML = `
                    <div class="mb-3">
                        <label class="form-label">平台代币地址</label>
                        <input type="text" class="form-control" name="platformTokenAddress" 
                               value="${deploymentStatus.platformTokenAddress}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">费用接收者地址</label>
                        <input type="text" class="form-control" name="feeRecipient" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">费用基点</label>
                        <input type="number" class="form-control" name="feeBasisPoints" 
                               value="250" min="0" max="10000" step="1" required>
                    </div>
                `;
            } else if (contractType === 'rewards') {
                fieldsContainer.innerHTML = `
                    <div class="mb-3">
                        <label class="form-label">平台代币地址</label>
                        <input type="text" class="form-control" name="platformTokenAddress" 
                               value="${deploymentStatus.platformTokenAddress}" required>
                    </div>
                `;
            }
        }

        // 处理单个合约部署
        async function handleSingleDeployment(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const contractType = document.getElementById('contractType').value;
            const deployerPrivateKey = document.getElementById('deployerPrivateKey').value;
            
            addLogEntry('info', `开始部署 ${contractType} 合约...`);
            
            try {
                const requestData = {
                    deployerPrivateKey: deployerPrivateKey
                };
                
                // 添加合约特定字段
                const specificFields = document.querySelectorAll('#contractSpecificFields input');
                specificFields.forEach(field => {
                    if (field.name) {
                        requestData[field.name] = field.value;
                    }
                });
                
                const response = await fetch(`/api/blockchain/deployment/${contractType}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    addLogEntry('success', `${contractType} 合约部署成功！地址: ${result.data.contractAddress}`);
                    addLogEntry('info', `交易哈希: ${result.data.transactionHash}`);
                    addLogEntry('info', `Gas使用量: ${result.data.gasUsed}`);
                    
                    // 重新加载部署状态
                    setTimeout(() => {
                        loadDeploymentStatus();
                    }, 1000);
                } else {
                    addLogEntry('error', `${contractType} 合约部署失败: ${result.message}`);
                }
            } catch (error) {
                addLogEntry('error', `部署 ${contractType} 合约时发生错误: ${error.message}`);
            }
        }

        // 处理批量部署
        async function handleBatchDeployment(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            
            addLogEntry('info', '开始批量部署所有合约...');
            
            try {
                const requestData = {
                    deployerPrivateKey: document.getElementById('batchDeployerPrivateKey').value,
                    feeRecipient: document.getElementById('feeRecipient').value,
                    platformTokenName: 'Platform Token',
                    platformTokenSymbol: 'PLT',
                    gameNFTName: 'Game NFT',
                    gameNFTSymbol: 'GAME',
                    agentNFTName: 'Agent NFT',
                    agentNFTSymbol: 'AGENT',
                    gameCreationFee: parseInt(document.getElementById('gameCreationFee').value) * Math.pow(10, 18),
                    agentCreationFee: parseInt(document.getElementById('agentCreationFee').value) * Math.pow(10, 18),
                    marketplaceFeeBasisPoints: Math.round(parseFloat(document.getElementById('marketplaceFeeRate').value) * 100)
                };
                
                const response = await fetch('/api/blockchain/deployment/all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    addLogEntry('success', '批量部署完成！');
                    
                    // 显示每个合约的部署结果
                    Object.entries(result.data).forEach(([contractType, deploymentResult]) => {
                        if (deploymentResult.success) {
                            addLogEntry('success', `${contractType} 部署成功: ${deploymentResult.contractAddress}`);
                        } else {
                            addLogEntry('error', `${contractType} 部署失败: ${deploymentResult.errorMessage}`);
                        }
                    });
                    
                    // 重新加载部署状态
                    setTimeout(() => {
                        loadDeploymentStatus();
                    }, 2000);
                } else {
                    addLogEntry('error', '批量部署失败: ' + result.message);
                }
            } catch (error) {
                addLogEntry('error', '批量部署时发生错误: ' + error.message);
            }
        }

        // 添加日志条目
        function addLogEntry(type, message) {
            const logContainer = document.getElementById('deploymentLog');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
    </script>
</body>
</html>
